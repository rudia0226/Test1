SELECT
	AREA_CD , REGION_AREA, NM 
	,  COL0 || ' ('  ||   TO_CHAR(ROUND(COL0/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL0, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK0,MAX_RK)) COL0
	,  COL1 || ' ('  ||   TO_CHAR(ROUND(COL1/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL1, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK1,MAX_RK)) COL1
	,  COL2 || ' ('  ||   TO_CHAR(ROUND(COL2/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL2, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK2,MAX_RK)) COL2
	,  COL3 || ' ('  ||   TO_CHAR(ROUND(COL3/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL3, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK3,MAX_RK)) COL3
	,  COL4 || ' ('  ||   TO_CHAR(ROUND(COL4/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL4, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK4,MAX_RK)) COL4
	,  COL5 || ' ('  ||   TO_CHAR(ROUND(COL5/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL5, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK5,MAX_RK)) COL5
	,  COL6 || ' ('  ||   TO_CHAR(ROUND(COL6/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL6, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK6,MAX_RK)) COL6
	,  COL7 || ' ('  ||   TO_CHAR(ROUND(COL7/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL7, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK7,MAX_RK)) COL7
	,  COL8 || ' ('  ||   TO_CHAR(ROUND(COL8/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL8, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK8,MAX_RK)) COL8
	,  COL9 || ' ('  ||   TO_CHAR(ROUND(COL9/TOT*100,2), 'FM990.09')|| '%)'  || DECODE(COL9, GREATEST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▲', LEAST(COL0,COL1,COL2,COL3,COL4,COL5,COL6,COL7,COL8,COL9), ' ▼') || DECODE(GR,'00',' *'||NVL(RK9,MAX_RK)) COL9
FROM 
		(
		SELECT AREA_CD , REGION_AREA
				 , DECODE(GROUPING(AREA_CD)||GROUPING(REGION_AREA), '00' , MAX(CD_NM), '01' , MAX(CD_NM)||'합계', '총계') NM
				 , GROUPING(AREA_CD)||GROUPING(REGION_AREA)  GR
				  ,NVL(  SUM(DECODE(PROD_ID,'100000',SALE_CNT)) , 0) COL0
			      ,NVL(  SUM(DECODE(PROD_ID,'100001',SALE_CNT)) , 0) COL1
			      ,NVL(  SUM(DECODE(PROD_ID,'100002',SALE_CNT)) , 0) COL2
			      ,NVL(  SUM(DECODE(PROD_ID,'100003',SALE_CNT)) , 0) COL3
			      ,NVL(  SUM(DECODE(PROD_ID,'100004',SALE_CNT)) , 0) COL4
			      ,NVL(  SUM(DECODE(PROD_ID,'100005',SALE_CNT)) , 0) COL5
			      ,NVL(  SUM(DECODE(PROD_ID,'100006',SALE_CNT)) , 0) COL6
			      ,NVL(  SUM(DECODE(PROD_ID,'100007',SALE_CNT)) , 0) COL7
			      ,NVL(  SUM(DECODE(PROD_ID,'100008',SALE_CNT)) , 0) COL8
			      ,NVL(  SUM(DECODE(PROD_ID,'100009',SALE_CNT)) , 0) COL9
			      ,MIN(DECODE(PROD_ID,'100000',RK)) RK0
		          ,MIN(DECODE(PROD_ID,'100001',RK)) RK1
		          ,MIN(DECODE(PROD_ID,'100002',RK)) RK2
		          ,MIN(DECODE(PROD_ID,'100003',RK)) RK3
		          ,MIN(DECODE(PROD_ID,'100004',RK)) RK4
		          ,MIN(DECODE(PROD_ID,'100005',RK)) RK5
		          ,MIN(DECODE(PROD_ID,'100006',RK)) RK6
		          ,MIN(DECODE(PROD_ID,'100007',RK)) RK7
		          ,MIN(DECODE(PROD_ID,'100008',RK)) RK8
		          ,MIN(DECODE(PROD_ID,'100009',RK)) RK9  
			      ,MAX(RK) + 1 MAX_RK   -- 위에서 NVL로 비어있는경우 무조건 마지막 번호를 붙여줘야 하니까 +1 
			      ,SUM(SALE_CNT) TOT 
		FROM 
				(
				SELECT AREA_CD 
						, REGION_AREA
				, PROD_ID 
				, SUM(SALE_CNT) SALE_CNT 
				, DENSE_RANK() OVER(PARTITION BY AREA_CD,REGION_AREA ORDER BY SUM(SALE_CNT) DESC) RK -- 중복순위 허용 ; DENSE_RANK()
		FROM SALE_TBL 
		WHERE AREA_CD = NVL(:ARG_AREA_CD,AREA_CD) -- SELECTBOX 
                AND ROWNUM <= NVL(:ARG_CNT,20000000)
        GROUP BY AREA_CD
				, REGION_AREA
				, PROD_ID 
         )TA, CD_TBL TB
    WHERE TA.AREA_CD = TB.CD_ID
    GROUP BY ROLLUP(AREA_CD ,REGION_AREA)
) WHERE GR = (DECODE(:ARG_GR,'D','00','M','01','T','11',GR))
ORDER BY  
         DECODE(AREA_CD, 10, :ARG_SEOUL
         						  , 20, :ARG_KYUNGKI
         						  , 30, :ARG_INCHEON
         						  , 40, :ARG_PYUNGTEK
         						  , 50, :ARG_ULSAL
         						  , 60 , :ARG_DAEJOEN
         						  , 70, :ARG_BUSAN
         						  , 80, :ARG_GWANJU
         						  , 90, :ARG_JEAJU)
         , AREA_CD          
         , DECODE(:ARG_DIR,'F', 1, -1) * GR 
;

COMMIT;

SELECT * FROM CD_TBL;
SELECT * FROM SALE_TBL
WHERE AREA_CD = '90'
ORDER BY REGION_AREA, PROD_ID
;











