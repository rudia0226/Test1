
SELECT * FROM DIA_TBL;


DROP TABLE DIA_TBL PURGE;


CREATE TABLE DIA_TBL (
	NID NUMBER,
	PID NUMBER,
	NAME VARCHAR2(100)
);





SELECT 
	LPAD(' ', (LEVEL-1)*6 )|| 'ㄴ' || NAME  AS 계층
	, NID, PID, NAME
FROM DIA_TBL
CONNECT BY PRIOR NID = PID
START WITH PID IS NULL;



CREATE TABLE DIA_TBL_CPTBL AS 
SELECT * 
FROM DIA_TBL;


ALTER TABLE DIA_TBL_CPTBL ADD PN_ID VARCHAR2(100);
ALTER TABLE DIA_TBL_CPTBL RENAME COLUMN NAME TO N_ID;

SELECT * FROM DIA_TBL_CPTBL;



SELECT 
	NID, PID, N_ID
	, LTRIM(LPAD(' ',( LEVEL-1)*6) || ' ' || PID, ' ')

FROM 
DIA_TBL_CPTBL
CONNECT BY PRIOR NID =    PID
START WITH PID IS NULL
;


CREATE TABLE DIA_TB AS 
(
SELECT * FROM DIA_TBL_CP
);


MERGE INTO DIA_TBL_CPTBL A
USING DIA_TBL_CPTBL B
ON (A.PID = B.NID)
WHEN METCHED THEN 
UPDATE SET A.PN_ID = B.N_ID;


SELECT *
FROM 
DIA_TB;




-- 특수구문
WITH T01 AS 
(
SELECT ROWNUM RNUM
FROM DUAL
CONNECT BY LEVEL <= 3
),
T02 AS 
(
SELECT MOD(ROWNUM,3)+1 RNUM
FROM DUAL
CONNECT BY LEVEL <= 3
)
SELECT * 
FROM T01 A, T02 B
WHERE A.RNUM = B.RNUM;


CREATE TABLE DIA_TRANS_TBL AS 
(
SELECT * FROM TRANS_TBL
);


CREATE TABLE DIA_MASTER_TBL AS 
(
SELECT * FROM MASTER_TBL
);



-- 93페이지 

SELECT * FROM DIA_TRANS_TBL;
SELECT * FROM DIA_MASTER_TBL;

ROLLBACK;

MERGE INTO DIA_MASTER_TBL TA
	USING (
			SELECT A.ACCNT
				, A.BALNC
				, A.TRANS_RSN
			FROM DIA_TRANS_TBL A
			 , DIA_MASTER_TBL  B 
			 WHERE A.ACCNT = B.ACCNT(+)
		 	  ) TB
	ON (TA.ACCNT = TB.ACCNT)
WHEN MATCHED THEN 
--	UPDATE SET TA.BALNC = TA.BALNC + TB.BALNC WHERE TB.TRANS_RSN = '입금'
--	UPDATE SET TA.BALNC = TA.BALNC + TB.BALNC WHERE TB.ACCNT NOT IN('A118','A119')
--	UPDATE SET TA.BALNC = TA.BALNC + TB.BALNC WHERE TB.ACCNT IN ('A118','A119')
	UPDATE SET TA.BALNC = TA.BALNC + TB.BALNC   -- UPDATE 조건에 포함되어야 실행이 된다. 1,2 는 포함되는 교집합관계가 없어서 실행이안됨 
	DELETE WHERE TB.TRANS_RSN = '해지'
WHEN NOT MATCHED THEN 
	INSERT(ACCNT,BALNC) VALUES(TB.ACCNT, TB.BALNC) 
;




























