
-- 71PAGE

SELECT NO 번호
	, ST_DT1 시작일자
	, ET_DT1 종료일자
	, NM 고객명
FROM
	(
	SELECT 
		NO, NM
		, ST_DT
		, ET_DT
		, SEQ
		, DECODE(SEQ, 1, ST_DT
					, NULL ,  MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
					 ) ST_DT1
		, DECODE(SEQ, 1,DECODE(SEQ, NULL, NULL,  MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  )
						, NULL, MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
					  ) ET_DT1
		
	FROM
			(			
			SELECT 	NO  ,NM
						,  ST_DT
						,  ET_DT
						, DECODE(ST_DT, LAG(ET_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT ), NULL, '1') SEQ
						, DECODE(ST_DT, LAG(ET_DT) OVER(PARTITION BY NM ORDER BY NO, 
			FROM ORG_TBL
			ORDER BY NO, ST_DT
			)
	)
)
WHERE ST_DT1 != ET_DT1
ORDER BY ST_DT
;


------------------------------------
-- 수정본


SELECT 
NO
, ST_DT1
, ET_DT1
,  NM

FROM 
(

	SELECT 
		NO, NM
		, ST_DT
		, ET_DT
		, SEQ
		, DECODE(SEQ, 1, ST_DT
					, NULL ,  MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
					 ) ST_DT1
		
		, DECODE(SEQ, 1, ET_DT
						, NULL, MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
					  ) ET_DT1
		
	FROM
			(			
			SELECT 	NO  ,NM
						,  ST_DT
						,  ET_DT
						, DECODE(ST_DT, LAG(ET_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT ), NULL, '1') SEQ
			FROM ORG_TBL
			ORDER BY NO, ST_DT
		)
)
WHERE ST_DT1 != ET_DT1
ORDER BY ST_DT1
;


------------------------------------






SELECT 
		NO, NM
		, ST_DT
		, ET_DT
		, SEQ
		, DECODE(SEQ || SEW , NULL , ST_DT
					 ,  MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
					 ) ST_DT1
		
		, DECODE(SEQ || SEW, NULL, ET_DT
						, MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
					  ) ET_DT1
		
	FROM
			(			
			SELECT 	NO  ,NM
						,  ST_DT
						,  ET_DT
						,  DECODE(ET_DT, LEAD(ST_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT) , NULL, 1) SEW
						,  DECODE(ST_DT, LAG(ET_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT ),NULL , 1) SEQ
			FROM ORG_TBL
			ORDER BY NO, ST_DT
		);
		
	------------------------
	
		
SELECT 	NO  ,NM
						,  ST_DT
						,  ET_DT
						,  SEW || SEQ
						, DECODE(SEQ|| SEQ, NULL, ST_DT,  MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))  ST_DT1
						,  DECODE(SEQ|| SEQ, NULL, ET_DT,  MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))  ET_DT1
	FROM(
		SELECT 	NO  ,NM
						,  ST_DT
						,  ET_DT
						,  DECODE(ET_DT, LEAD(ST_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT) , NULL, 0) SEW
						,  DECODE(ST_DT, LAG(ET_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT ),NULL, 1) SEQ
			FROM ORG_TBL
			ORDER BY NO, ST_DT
		);
	
	
		
	------------------------
	
	
	
	
	
	
	
		------------------------
	
	
	
SELECT 
NO
, ST_DT1
, ET_DT1
,  NM

FROM 
(

	SELECT 
		NO, NM
		, ST_DT
		, ET_DT
		, SEQ
		, DECODE(SEQ, 1, ST_DT
					, NULL ,  MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
					 ) ST_DT1
		
		, DECODE(SEQ, 1, ET_DT
						, NULL, MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)
					  ) ET_DT1
		
	FROM
			(			
			SELECT 	NO  ,NM
						,  ST_DT
						,  ET_DT
						, DECODE(ST_DT, LAG(ET_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT ), NULL, '1') SEQ
			FROM ORG_TBL
			ORDER BY NO, ST_DT
		)
)
WHERE ST_DT1 != ET_DT1
ORDER BY ST_DT1
;
	
	
	
	
	
SELECT 
 MAX(NO)
 , MAX(NM)
 , ST_DT1
 , ET_DT1
 FROM
(
;
SELECT
	NO, NM, ST_DT, ET_DT                
	, DECODE(SEQ || SEW, 'BA', ST_DT,  MIN(ST_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))  ST_DT1
	, DECODE(SEQ || SEW, 'BA', ET_DT,  MAX(ET_DT) OVER(PARTITION BY NM  ORDER BY NO, ST_DT ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))  ET_DT1
	, SEQ
	, SEW
	, SEQ || SEW
FROM(
		SELECT 	NO  ,NM
						,  ST_DT
						,  ET_DT
						,  DECODE(ET_DT, LEAD(ST_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT) ,NULL , 'A') SEW
						,  DECODE(ST_DT, LAG(ET_DT) OVER(PARTITION BY NM ORDER BY NO, ST_DT ), NULL, 'B') SEQ
			FROM ORG_TBL
			ORDER BY NO, ST_DT
		);
)
GROUP BY (ST_DT1, ET_DT1)		
ORDER BY ST_DT1
;
	
	
	